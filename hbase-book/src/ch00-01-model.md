# 数据模型
HBase 是一个 K-V 型的数据库，从逻辑视图上看数据是以表的形式进行组织的，并且和关系型数据库一样表也由行和列组成；从物理视图来看，HBase 是一个 Map，其数据是由 K-V 构成，不一样的是 HBase 是稀疏的、分布式的、多维有序的 Map。

### 逻辑视图

HBase 和关系型数据库具有类似的术语：

- **命名空间(Namespace)**：命名空间是表的逻辑分组，类似于关系型数据库中的数据库。在创建表的时候使用 ```<table_namespace>:<table_name>``` 指定表的命名空间。系统预置了两个命名空间：hbase 是系统命名空间，包含 HBase 内部的表；default 是默认的命名空间，没有显式指定命名空间的表会自动的分组到这个命名空间
- **表(Table)**：HBase 的 Table 是由多个 Row 组成。HBase 中的每个表都有自己的目录，位于 HBase 根目录(/hbase)下，每个表目录包含一个名为 .tableInfo 的顶层文件，该文件保存了针对该表的元数据信息 HTableDescriptor 序列化之后的内容。在插入数据之前需要先创建表
- **行(Row)**：HBase 的行由一个行键(rowKey)以及多个列(column)组成。HBase 表中所有的行按照行键的字典顺序存储，因此行键的设计非常重要
- **列(Column)**：HBase中的列由列族(column family)和列限定符(qualifier)组成，列族和列限定符由 ：(冒号)分隔
- **列族(Column Family)**：列族在物理上通常出于性能原因将一组列及其值合并在一起。每个列族都有一组存储属性，例如是否应将其值缓存在内存中、如何压缩其数据或对其行键进行编码等。列族在表创建的时候需要指定，一个列族下可以设置任意多个列限定符，即一个列族可以有任意多个列
- **单元格(Cell)**：Cell 是由五元组 (row, column, timestamp, type, value) 组成的结构，其中 type 表示操作类型(PUT/DELETE)，timestamp 表示值的版本
- **时间戳(Timestamp)**：每个值都伴随着一个时间戳，是给定版本值的标识符。默认情况下，时间戳表示写入数据时 RegionServer 上的时间，在 Put 数据的时候可以指定时间戳

插入行数据时，不同的列的值插入到表的对应列中，当某些列没有数据时不会占用额外的空间，使用一个多维的 Map 更能表示逻辑视图：
```
+--------+---------------+---------------+-----------+
|        |       cf1     |      cf2      |           |
| rowkey +---------------+---------------+ Timestamp |
|        |  c1  |   c2   |  c1  |   c2   |           |
+--------+------+--------+------+--------+-----------+
|   r1   |  v1  |        |  v1  |   v2   |     t1    |
+--------+------+--------+------+--------+-----------+
|   r1   |      |    v1  |  v1  |        |     t2    |
+--------+------+--------+------+--------+-----------+
|   r1   |      |        |  v1  |        |     t3    |
+--------+------+--------+------+--------+-----------+


{
    "rowkey1":{
        cf1:{
            t1:cf:column:"value"
            t2:cf:column:"value"
        }
        cf2:{
            t1:column:value
            t2:column:value
        }
        cf3:{}
    }
    "rowkey2":{

    }
}
```


### 物理视图

从物理视图上看，HBase 是一个 Map，其中 Key 是一个复合键，由 rowkey, column family, qualifier, type 以及 timestamp 组成，Value 为数据的值。

HBase 的 Map 存储结构使得其具备稀疏、分布式、多维有序的特性：
- **稀疏**：HBase 本质是使用 K-V 存储数据，不同的列组成不同的 K 而不会使用 null 来填充，因此使得 HBase 看起来十分的稀疏。HBase 的稀疏性使得其节省了大量因填充策略导致的空间浪费，也是由于 HBase 的稀疏性使得其可以支持上百万的列
- **多维**：HBase 中 Map 的 Key 是由多个数据复合组成，使得整个 Map 看起来有多个维度
- **有序**：HBase 的有序不仅仅是按照 rowkey 排序，而是先比较 rowkey，如果 rowkey 相同则比较 column，如果 column 相同则比较 timestamp，即版本信息。HBase 数据是按照字典序排序，当 rowkey 和 column 相同时则按照 timestamp 倒序排序。HBase 的有序性是 HBase 具有高性能读写的基础

HBase 的数据是按照列簇存储的，即将数据按照所属的列簇分别存放在不同的目录中，默认存储位置为 ```/hbase/table_name/cf```。

- **行式存储**：行式存储系统将一行数据存储在一起，这样在获取一行数据时比较高效，但是对于只需要部分列中的数据的查询，行式存储系统需要先将所有的列的数据查询出来，然后过滤掉不需要的行数据，这种方式会大量的浪费内存以及 IO，大多数关系型数据库采用行式存储方式存储数据
- **列式存储**：列式存储将一列数据存储在一起，这样在需要查询某些列时只需要查询对应列的数据即可，但是对于需要一整行数据的查询需要多次读取数据(多次 IO)使得读取性能下降
- **列簇式存储**：列簇式存储介于列式存储和行式存储之间，可以通过不同的设计思路在行式存储和列式存储之间相互切换。如果只设置一个列簇则相当于行式存储，如果设置多个列簇则相当于列式存储

### HBase 优缺点

与其他数据库相比，HBase 在系统设计以及实际实践中有很多独特的优点：
- **容量巨大**：HBase 的单表可以支持千亿行、百万列的数据规模，数据容量可以达到 TB 甚至 PB 级别
- **良好的可扩展性**：HBase 集群可以非常方便地实现集群容量扩展，主要包括数据存储节点扩展以及读写服务节点扩展。HBase 底层数据存储依赖于 HDFS，可以通过增加 DataNode 实现扩展，而 HBase 的读写节点也是可以通过增加 RegionServer 节点实现扩展
- **稀疏性**：HBase 支持大量稀疏存储，即允许大量列值为空，并不占用任何存储空间
- **高性能**：HBase 主要擅长于 OLTP 场景，数据写操作性能强劲；对于随机单点读取以及小范围的扫描读，其性能也能得到保证
- **多版本**：HBase 支持多版本特性，即一个 K-V 可以同时保留多个版本，用户可以根据需要选择最新版本或者某个历史版本
- **支持过期**：HBase 支持 TTL 过期特性，只需要设置过期时间，超过 TTL 的数据就会被自动清理而不需要手动清理
- **Hadoop 原生支持**：HBase 数据存储依赖于 HDFS，因此可以绕过 HBase 直接操作 HDFS 文件从而高效的完成数据扫描或者数据导入

HBase 为了实现上述特性舍弃了一些功能，因而 HBase 也不能适用所有的应用场景：
- HBase 不支持很复杂的聚合运算
- HBase 没有实现二级索引
- HBase 不支持全局跨行事务，只支持单行事务