### Kafka 概念
#### 主题
Kafka 将一组消息抽象为主题(Topic)，也就是说一个主题对应一个消息的分类，生产者将消息发送到特定主题消费者订阅主题或主题的某些分区进行消费。
#### 消息
消息是 Kafka 的基本单位，由一个定长的消息头和一个变长的消息体构成，每条消息称为一个 Record。
#### 分区和副本
每个主题被分为一个或多个分区(Partition)，每个分区由一系列有序、不可变的消息组成，是一个有序队列。每个分区在物理上对应一个文件夹，文件夹命名格式为 ```TopicName_partitionNo```。

每个分区有一个或多个副本(Replica)，分区的副本分布在集群的不同代理上以提高可用性，分区的副本在逻辑上抽象为一个日志(Log)对象。分区使得 Kafka 在并发处理上变得更加容易，理论上说分区越多吞吐量越大，分区也是 Kafka 保证消息被顺序消费以及对消息进行负载均衡的基础；

Kafka 只能保证一个分区内的消息是有序的，不能保证分区间消息的有序性。每条消息是追加到分区中，由于是顺序写磁盘因此效率非常高；Kafka 消息消费之后不会立即删除，Kafka 提供了基于存储时间和基于分区长度两种删除消息的策略，可以通过配置文件设置。
#### 副本 leader 和 follower
分区有多个副本，需要保证副本之间的数据一致性，Kafka 会选择分区副本中的一个作为 leader 负责处理客户端的读写请求，其他副本作为 follower 同步 leader 的数据，如果 leader 失效 follower 通过选举选出一个 follower 作为新的 leader 对外提供服务。
#### 偏移量
任何发送到分区的消息都是直接追加到日志文件(分区目录下以 .log 结尾的文件)的尾部，每条消息在日志文件中的位置都会对应一个按序递增的偏移量。**偏移量在一个分区下是严格递增的逻辑值，不表示消息在磁盘的物理地址**。Kafka 不会为偏移量提供额外的索引机制，消费者通过控制消息的偏移量对消息进行消费，消费者对偏移量的操作不会影响消息本身的偏移量。
#### 日志段
Kafka 的数据日志被划分为多个日志段(LogSegment)，日志段是 Kafka 日志对象分片的最小单位，和日志对象(Log)一样也是逻辑概念。一个日志段对应磁盘上一个具体的日志文件(.log 结尾，用于保存消息实际数据)和两个索引文件(分别以 .index 结尾的消息偏移量索引文件和以 .timeindex 结尾的消息时间戳索引文件)
#### 代理
代理(Broker)表示 Kafka 集群的一个实例，每个代理都有一个集群唯一的 id，在启动代理的时候通过 broker.id 指定。
#### 生产者
生产者(Producer)负责将消息发送给代理，也就是 Kafka 代理发送消息的客户端。
#### 消费者和消费组
消费者(Consumer)以 pull 的方式获取数据，是 Kafka 消费消息的客户端。Kafka 中每个消费者都属于一个消费组(Consumer Group)，消费组通过 group.id 指定集群唯一，可以为消费者指定消费组如果没有指定则默认为 test-consumer-group；消费者也有集群唯一的 id，通过 client.id 指定，如果没有指定则默认为 ```${groupId}-${hostName}-${timestamp}-${UUID前8位}```。

**同一个主题的消息只能被同一个消费组下某一个消费者消费，但不同消费组的消费者可同时消费该消息**；消费组是 Kafka 用来实现对一个消息进行广播和单播的手段，实现消息广播只需要指定各消费者属于不同的消费组，实现消息单播只需要让各消费者属于同一个消费组。
#### ISR
Kafka 在 Zookeeper 中动态维护了一个 ISR(In-sync Replica) 列表，该列表中保存的是与 leader 保持消息同步的副本对应的 broker 的 id，如果一个 follower 落后于 leader 太多则会从 ISR 列表中删除。当 leader 失效时，只有在 ISR 中的 follower 才有可能被选举为新的 leader。
#### Zookeeper
Kafka 利用 Zookeeper 保存元数据信息，如代理节点信息、Kafka 集群信息、主题信息、分区状态信息、分区副本信息、动态配置信息等，Kafka 在启动时会在 Zookeeper 创建节点保存元数据信息，然后监听节点数据的变化从而感知 Kafka 集群的变化。
### Kafka 特性
- **消息持久化**：Kafka 依赖文件系统持久化消息，数据的持久化采用对文件的追加实现，时间复杂度为 O(1)，因此即使是存储海量的消息也不会影响性能
- **高吞吐量**：Kafka 顺序写数据的同时采用零拷贝(zero-copy)技术，采用 sendFile() 函数在内核中操作两个文件描述符之间直接传递数据而避免了内核缓冲区与用户缓冲区之间的数据拷贝，同时 Kafka 还支持数据压缩和批量发送以及多分区是的 Kafka 的吞吐量达到每秒百万级别
- **扩展性**：Kafka 使用 Zookeeper 对集群进行协调管理，生产者、消费者和代理都可以配置多个，同时在集群扩展时不需要停机，集群能够自动感知并重新进行负载均衡和数据复制。
- **数据备份**：Kafka 可以为每个主题指定副本数对数据进行持久化备份，可以一定程度上防止数据丢失提高可用性
- **轻量级**：Kafka 代理是无状态的，即代理不记录消息是否消费，消费偏移量有消费者自己维护，同时集群本身几乎不需要生产者和消费者的状态信息
### Kafka 安装

**[Back](../)**